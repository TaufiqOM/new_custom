<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Report Template -->
        <template id="report_pre_shipping_template">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-call="web.basic_layout">
                        <div class="page">
                            <div class="oe_structure"/>
                            <div class="row">
                                <div class="col-10">
                                    <h2 style="font-weight: bold; margin-bottom: -3px;">Pre Shipping Report</h2>
                                    <h5 style="font-weight: bold; margin-bottom: -3px;">
                                        ID Shipping :<span t-esc="doc.description"/> | Shipping Date : <t t-esc="doc.scheduled_date.strftime('%d %B %Y') if doc.scheduled_date else ''"/>
                                    </h5>
                                    <span style="font-weight: bold; display:block; margin-bottom: 3px;">
                                        To: <t t-esc="doc.buyer"/>
                                    </span>
                                    <span style="font-weight: bold;">Status Shipping : <t t-esc="dict(doc._fields['state'].selection).get(doc.state, '##')"/> | Status Container : ##</span>
                                </div>
                                <div class="col-2" style="text-align: center; top: 0">
                                    <t t-if="doc.company_id.logo">
                                        <img t-att-src="'data:image/png;base64,%s' % (doc.company_id.logo.decode())"
                                             style="max-height: 100px; object-fit: contain;"
                                             alt="Company Logo"/>
                                    </t>
                                        <div style="text-align: center; font-size: 9px; margin-top: -20px;">
                                            <t t-set="now" t-value="datetime.datetime.utcnow() + datetime.timedelta(hours=7)"/>
                                            <span>Printed on :
                                                <t t-esc="now.strftime('%d %b %Y %H:%M:%S')"/> (UTC+7)
                                            </span>
                                            <div style="font-size:20px; font-weight: bold"><t t-esc="doc.jenis_kontainer or '##'"/></div>
                                        </div>
                                </div>
                            </div>
                            <!-- TABLE HEADER -->
                            <table class="table table-borderless mt-4"
                                    style="font-family: Arial;
                                            font-size: 10px;
                                            letter-spacing: 0.05em;
                                            line-height: 1.1;
                                            table-layout: fixed;
                                            width: 100%;
                                            border-collapse: collapse;">
                                <colgroup>
                                    <col style="width:7%;" />
                                    <!-- Picture -->
                                    <col style="width:4.5%;" />
                                    <!-- Prod. ID -->
                                    <col style="width:14%;" />
                                    <!-- Product Name -->
                                    <col style="width:4%;" />
                                    <!-- Color -->
                                    <col style="width:4.5%;" />
                                    <!-- Price -->
                                    <col style="width:19%;" />
                                    <!-- Product Extra Info To Buyer -->
                                    <col style="width:3.5%;" />
                                    <!-- SHP -->
                                    <col style="width:3.5%;" />
                                    <!-- AV -->
                                    <col style="width:3.5%;" />
                                    <!-- RAW -->
                                    <col style="width:3.5%;" />
                                    <!-- KD -->
                                    <col style="width:3.5%;" />
                                    <!-- Out -->
                                    <col style="width:3.5%;" />
                                    <!-- SND -->
                                    <col style="width:4%;" />
                                    <!-- QCIN -->
                                    <col style="width:3.5%;" />
                                    <!-- CLR -->
                                    <col style="width:4.2%;" />
                                    <!-- QCFIN -->
                                    <col style="width:3.5%;" />
                                    <!-- FinP -->
                                    <col style="width:3.5%;" />
                                    <!-- STR -->
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #a0a0a0; color: black; border: 1px solid black; font-size: 12px; line-height: 1.1;"
                                        class="text-center align-middle">
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Picture</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Prod. ID</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Product Name</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Color</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Price</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Product Extra Info To Buyer</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">SHP</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">AV</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">RAW</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">KD</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">Out</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">SND</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">QCIN</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">CLR</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">QCFIN</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">FinP</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;">STR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="17" style="height: 1px"></td>
                                    </tr>
                                    <!-- Group by sale_id -->
                                    <t t-set="sale_groups" t-value="{}"/>
                                    <t t-set="total_qty" t-value="0"/>
                                    <t t-set="total_av" t-value="0"/>
                                    <t t-set="total_raw" t-value="0"/>
                                    <t t-set="total_kd" t-value="0"/>
                                    <t t-set="total_out" t-value="0"/>
                                    <t t-set="total_snd" t-value="0"/>
                                    <t t-set="total_qcin" t-value="0"/>
                                    <t t-set="total_clr" t-value="0"/>
                                    <t t-set="total_qfin" t-value="0"/>
                                    <t t-set="total_finp" t-value="0"/>
                                    <t t-set="total_str" t-value="0"/>
                                    <t t-foreach="doc.picking_ids" t-as="picking">
                                        <t t-foreach="picking.move_ids" t-as="move">
                                            <t t-set="sale_id" t-value="picking.sale_id.client_order_ref or '##'"/>
                                            <t t-if="sale_id not in sale_groups">
                                                <t t-set="sale_groups" t-value="dict(sale_groups, **{sale_id: {'moves': [], 'due_date': picking.sale_id.due_date_order or '##', 'update_date': picking.sale_id.due_date_update_order or '##'}})"/>
                                            </t>
                                            <t t-set="sale_groups" t-value="dict(sale_groups, **{sale_id: {'moves': sale_groups[sale_id]['moves'] + [move], 'due_date': sale_groups[sale_id]['due_date'], 'update_date': sale_groups[sale_id]['update_date']}})"/>
                                            <t t-set="total_qty" t-value="total_qty + move.quantity"/>
                                        </t>
                                    </t>
                                    <t t-foreach="sale_groups" t-as="sale_id">
                                        <t t-set="group_data" t-value="sale_groups[sale_id]"/>
                                        <!-- Group header row: colspan=8 will span columns 1..8 (sampai AV) -->
                                        <tr style="color: black; border: 1px solid black;">
                                            <td style="border: 1px solid black;" colspan="8">
                                                <span>ID Order :</span>
                                                <h3 style="margin: 2px 0; font-weight: bold"><t t-esc="sale_id"/></h3>
                                            </td>
                                            <!-- next colspan 4 will cover kolom 9..12 (RAW, KD, Out, SND) -->
                                            <td style="border: 1px solid black;" colspan="4">
                                                <span>Due Date :</span>
                                                <h5 style="margin: 2px 0; font-weight: bold"><t t-esc="group_data['due_date'].strftime('%d %b %Y') if group_data['due_date'] != '##' else '##'"/></h5>
                                            </td>
                                            <!-- terakhir colspan 5 menutup kolom 13..17 (QCIN..STR) -->
                                            <td style="border: 1px solid black;" colspan="5">
                                                <span>Order Due Date Update :</span>
                                                <h3 style="margin: 2px 0; font-weight: bold"><t t-esc="group_data['update_date'].strftime('%d %b %Y') if group_data['update_date'] != '##' else ''"/></h3>
                                            </td>
                                        </tr>
                                        <!-- Data rows for each move in the group -->
                                        <t t-foreach="group_data['moves']" t-as="move">
                                            <t t-set="sale_lines" t-value="move.picking_id.sale_id and move.picking_id.sale_id.order_line.filtered(lambda l: l.product_id == move.product_id) or []"/>
                                            <t t-set="unit_price" t-value="sale_lines and sale_lines[0].price_unit or move.product_id.list_price"/>
                                            <tr style="color: black; border: 1px solid black; text-align: center;">
                                                <td style="border: 1px solid black; text-align: center; vertical-align: middle;">
                                                    <img t-if="move.product_id.image_1920" t-att-src="'data:image/png;base64,%s' % (move.product_id.image_1920.decode())" style="max-width: 100%; max-height: 80px; object-fit: contain;" alt="Product Image"/>
                                                    <t t-else="">##</t>
                                                </td>
                                                <td style="border: 1px solid black;"><t t-esc="move.product_id.default_code or '##'"/></td>
                                                <td style="border: 1px solid black; text-align:left; padding-left:4px;"><t t-esc="move.product_id.name or '##'"/></td>
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.color_attribute_size or ''"/></td>
                                                <td style="border: 1px solid black;"><t t-esc="'{0:,.2f}'.format(unit_price)"/></td>
                                                <td style="border: 1px solid black; text-align:left; padding-left:4px;"><t t-esc="sale_id + ' - ' + (move.product_id.name or '##')"/></td>
                                                <!-- small columns 7..17 -->
                                                <td style="border: 1px solid black;"><t t-esc="move.quantity"/></td>
                                                <!-- SHP -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_av or ''"/></td>
                                                <!-- AV -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_raw or ''"/></td>
                                                <!-- RAW -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_rpr or ''"/></td>
                                                <!-- KD -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_rtr or ''"/></td>
                                                <!-- Out -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_snd or ''"/></td>
                                                <!-- SND -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_qcin or ''"/></td>
                                                <!-- QCIN -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_clr or ''"/></td>
                                                <!-- CLR -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_qfin or ''"/></td>
                                                <!-- QCFIN -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_finp or ''"/></td>
                                                <!-- FinP -->
                                                <td style="border: 1px solid black;"><t t-esc="move.sale_line_id.production_str or ''"/></td>
                                                <!-- STR -->
                                            </tr>
                                        </t>
                                    </t>
                                    <tr style="background-color: #a0a0a0; color: black; border: 1px solid black; font-size: 11px; line-height: 1.1;"
                                        class="align-middle">
                                        <th style="text-align: right; border: 1px solid black; font-weight: bold;" colspan="6">Grand Total :</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_qty"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_av"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_raw"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_kd"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_out"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_snd"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_qcin"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_clr"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_qfin"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_finp"/></th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: bold;"><t t-esc="total_str"/></th>
                                    </tr>
                                     <tr>
                                        <td colspan="17" style="height: 1px"></td>
                                    </tr>
                                    <tr style="background-color: #181a1c; color: white; border: 1px solid black; font-size: 11px; line-height: 1.1;"
                                        class="align-middle">
                                        <td style="background-color: #181a1c; color: white; font-size:11px;" class="text-center align-middle p-1" colspan="17">Remark (Internal)</td>
                                    </tr>
                                     <tr>
                                        <td colspan="17" style="border: 1px solid black"><span t-esc="doc.remark_int"/></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="oe_structure"/>
                        </div>
                    </t>
                </t>
            </t>
        </template>
    </data>
</odoo>
