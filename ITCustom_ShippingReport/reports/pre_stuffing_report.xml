<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Report Template -->
        <template id="report_pre_stuffing_template">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-call="web.basic_layout">
                        <div class="page">
                            <div class="oe_structure"/>
                            <div class="row">
                                <div class="col-10">
                                    <h2 style="font-weight: bold; margin-bottom: -3px;">Pre Stuffing</h2>
                                    <h5 style="font-weight: bold; margin-bottom: -3px;">
                                        Customer :
                                        <span t-esc="doc.buyer.split('/')[0].strip() if doc.buyer else ''"/>
                                    </h5>
                                </div>
                                <div class="col-2" style="text-align: right">
                                    <t t-if="doc.company_id.logo">
                                        <img t-att-src="'data:image/png;base64,%s' % (doc.company_id.logo.decode())"
                                            style="max-height: 120px; object-fit: contain; margin-top: -23px"
                                            alt="Company Logo"/>
                                    </t>
                                </div>
                            </div>
                            <div class="row" style="margin-top: -23px">
                                <div class="col-8">
                                    <h5 style="font-weight: bold; margin-bottom: -3px;">
                                        <t t-esc="doc.description"/>,
                                        <t t-esc="doc.scheduled_date.strftime('%d %b %Y') if doc.scheduled_date else ''"/>
                                    </h5>
                                    <img t-if="doc.description" t-att-src="'data:image/png;base64,%s' % doc.get_qr_code(doc.description)" style="max-height: 100px; height: auto; border: 2px solid black; border-radius: 5px; margin-bottom: -3px;"/>
                                </div>
                                <div class="col-4" style="font-size: 11px; text-align: right">
                                    <t t-set="now" t-value="datetime.datetime.utcnow() + datetime.timedelta(hours=7)"/>
                                    <span>Printed on :
                                        <t t-esc="now.strftime('%A, %d %b %Y %H:%M:%S')"/> (UTC+7)
                                    </span>
                                    <table class="table table-borderless" style="font-size: 16px; font-weight: bold; width: 100%">
                                        <tr>
                                            <td style="width: 20%; text-align: left">Start</td>
                                            <td style="width: 80%; border-bottom: 1px solid black; text-align: left">:</td>
                                        </tr>
                                        <tr>
                                            <td style="width: 20%; text-align: left">Finish</td>
                                            <td style="width: 80%; border-bottom: 1px solid black; text-align: left">:</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <t t-set="order_groups" t-value="{}"/>
                            <t t-foreach="doc.picking_ids" t-as="picking">
                                <t t-if="picking.sale_id">
                                    <t t-foreach="picking.move_ids" t-as="move">
                                        <t t-set="default_code" t-value="move.product_id.default_code or 'N/A'"/>
                                        <t t-if="default_code not in order_groups">
                                            <t t-set="order_groups" t-value="dict(order_groups, **{default_code: {'due_date_order': picking.sale_id.due_date_order, 'products': {}}})"/>
                                        </t>
                                        <t t-set="product_name" t-value="move.product_id.name or 'N/A'"/>
                                        <t t-set="sale_lines" t-value="move.picking_id.sale_id and move.picking_id.sale_id.order_line.filtered(lambda l: l.product_id == move.product_id) or []"/>
<t t-set="info_to_production" t-value="sale_lines and sale_lines[0].info_to_production or '##'"/>
<t t-set="finish_product" t-value="sale_lines and (sale_lines[0].finish_product and {'name': sale_lines[0].finish_product.name, 'code': '[' + sale_lines[0].finish_product.code + ']'} or {'name': '', 'code': ''}) or {'name': '', 'code': ''}"/>
<t t-if="product_name not in order_groups[default_code]['products']">
    <t t-set="order_groups" t-value="dict(order_groups, **{
default_code: dict(order_groups[default_code], **{
'products': dict(order_groups[default_code]['products'], **{
            product_name: {
                'qty': 0,
                'default_code': move.product_id.default_code or '##',
                'due_date': picking.sale_id.due_date_order or '##',
                'barcodes': [],
                'info_to_production': info_to_production,
                'finish_product': finish_product,
                'total_height': sum(p.height for p in move.product_id.packaging_ids if p.height) or 0,
                'total_width': sum((p.width or 0) for p in move.product_id.packaging_ids) or 0,
                'total_length': sum((p.packaging_length or 0) for p in move.product_id.packaging_ids) or 0,
                'm3': sum(p.cbm for p in move.product_id.packaging_ids) or 0
            }
        })
    })
})"/>
                                        </t>
<t t-set="current" t-value="order_groups[default_code]['products'][product_name]"/>
<t t-set="new_barcodes" t-value="current['barcodes']"/>
<t t-foreach="move.move_line_ids" t-as="line">
    <t t-if="line.lot_id">
        <t t-set="new_barcodes" t-value="new_barcodes + [line.lot_id.name]"/>
    </t>
</t>
<t t-set="order_groups" t-value="dict(order_groups, **{
default_code: dict(order_groups[default_code], **{
    'products': dict(order_groups[default_code]['products'], **{
        product_name: {
            'qty': current['qty'] + move.quantity,
            'default_code': current['default_code'],
            'due_date': current['due_date'],
            'barcodes': new_barcodes,
            'info_to_production': current['info_to_production'],
            'finish_product': current.get('finish_product', '') or finish_product,
            'total_height': current['total_height'],
            'total_width': current['total_width'],
            'total_length': current['total_length'],
            'm3': current['m3']
        }
    })
})
})"/>
                                    </t>
                                </t>
                            </t>
                            <!-- TABLE HEADER -->
                            <table class="table table-borderless mt-4" style="font-family: Arial; letter-spacing: 0.05em; table-layout: fixed; width: 100%; border-collapse: collapse;">
                                <colgroup>
                                    <col style="width: 14%"/>
                                    <col style="width: 10%"/>
                                    <col style="width: 10%"/>
                                    <col style="width: 10%"/>
                                    <col style="width: 6%"/>
                                    <col style="width: 10%"/>
                                    <col style="width: 10%"/>
                                    <col style="width: 17%"/>
                                    <col style="width: 13%"/>
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #a0a0a0; color: black; border: 1px solid black; font-size: 16px; line-height: 1;" class="text-center align-middle">
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 14%; padding: 2px 4px;">Due Date</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 10%; padding: 2px 4px;">Order</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 10%; padding: 2px 4px;">Type</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 10%; padding: 2px 4px;">Color</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 8%; padding: 2px 4px;">Qty</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 8%; padding: 2px 4px;">M3 Wood</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 8%; padding: 2px 4px;">M3 Pack</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 14%; padding: 2px 4px;">Description</th>
                                        <th class="text-center" style="border: 1px solid black; font-weight: 900; width: 18%; padding: 2px 4px;">Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="9"></td>
                                    </tr>
                                    <t t-foreach="order_groups" t-as="client_ref">
                                        <t t-set="has_barcodes" t-value="False"/>
                                        <t t-foreach="order_groups[client_ref]['products']" t-as="product_name">
                                            <t t-if="order_groups[client_ref]['products'][product_name]['barcodes']">
                                                <t t-set="has_barcodes" t-value="True"/>
                                            </t>
                                        </t>
<t t-if="has_barcodes">
    <t t-if="len(order_groups[client_ref]['products']) == 1">
        <tr style="background-color: #a0a0a0; color: black; border: 1px solid black; font-size: 14px; line-height: 1;" class="align-middle">
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                <t t-esc="client_ref"/>
            </td>
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;" colspan="6">
                <t t-esc="product_name"/>
            </td>
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px; text-align: center;">
                <span style="font-weight: bold; font-size: 13px;">
                    <t t-esc="'%.1f' % order_groups[client_ref]['products'][product_name].get('total_height', 0)"/> X
                    <t t-esc="'%.1f' % order_groups[client_ref]['products'][product_name].get('total_width', 0)"/> X
                    <t t-esc="'%.1f' % order_groups[client_ref]['products'][product_name].get('total_length', 0)"/>
                </span>
            </td>
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
            </td>
        </tr>
        <tr style="border: 1px solid black; font-size: 14px; line-height: 1;" class="align-middle">
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                <t t-esc="order_groups[client_ref]['products'][product_name]['due_date'].strftime('%d %b %y') if order_groups[client_ref]['products'][product_name]['due_date'] else '##'"/>
            </td>
<td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
    <t t-esc="order_groups[client_ref]['products'][product_name]['barcodes'][0].split('-')[0] if order_groups[client_ref]['products'][product_name]['barcodes'] else 'N/A'"/>
</td>
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                FRE
            </td>
<td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
    <t t-esc="order_groups[client_ref]['products'][product_name]['finish_product']['name']"/>
    <br/>
    <t t-esc="order_groups[client_ref]['products'][product_name]['finish_product']['code']"/>
</td>
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                <t t-esc="int(order_groups[client_ref]['products'][product_name]['qty'])"/>
            </td>
            <td style="text-align: right; border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                <t t-esc="'%.4f' % (order_groups[client_ref]['products'][product_name]['m3'] * order_groups[client_ref]['products'][product_name]['qty'])"/>
            </td>
            <td style="text-align: right; border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                2.0184
            </td>
            <td style="text-align: right; border: 1px solid black; font-weight: 900; padding: 2px 4px;">
            </td>
            <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                NBL, PR-
                1* TOP
                URGENT
            </td>
        </tr>
    </t>
    <t t-foreach="order_groups[client_ref]['products']" t-as="product_name">
        <t t-if="order_groups[client_ref]['products'][product_name]['barcodes']">
            <t t-set="counter" t-value="1"/>
            <!-- Repeat the header above barcode if more than one product exists -->
            <t t-if="len(order_groups[client_ref]['products']) > 1">
                <tr style="background-color: #a0a0a0; color: black; border: 1px solid black; font-size: 14px; line-height: 1;" class="align-middle">
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        <t t-esc="client_ref"/>
                    </td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;" colspan="6">
                        <t t-esc="product_name"/>
                    </td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px; text-align: center;">
                        <span style="font-weight: bold; font-size: 13px;">
                            <t t-esc="'%.1f' % order_groups[client_ref]['products'][product_name].get('total_height', 0)"/> X
                            <t t-esc="'%.1f' % order_groups[client_ref]['products'][product_name].get('total_width', 0)"/> X
                            <t t-esc="'%.1f' % order_groups[client_ref]['products'][product_name].get('total_length', 0)"/>
                        </span>
                    </td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                    </td>
                </tr>
                <tr style="border: 1px solid black; font-size: 14px; line-height: 1;" class="align-middle">
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        <t t-esc="order_groups[client_ref]['products'][product_name]['due_date'].strftime('%d %b %y') if order_groups[client_ref]['products'][product_name]['due_date'] else '##'"/>
                    </td>
<td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
    <t t-esc="order_groups[client_ref]['products'][product_name]['barcodes'][0].split('-')[0] if order_groups[client_ref]['products'][product_name]['barcodes'] else 'N/A'"/>
</td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        FRE
                    </td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        
                    </td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        <t t-esc="int(order_groups[client_ref]['products'][product_name]['qty'])"/>
                    </td>
                    <td style="text-align: right; border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        <t t-esc="'%.4f' % (order_groups[client_ref]['products'][product_name]['m3'] * order_groups[client_ref]['products'][product_name]['qty'])"/>
                    </td>
                    <td style="text-align: right; border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        2.0184
                    </td>
                    <td style="text-align: right; border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                    </td>
                    <td style="border: 1px solid black; font-weight: 900; padding: 2px 4px;">
                        NBL, PR-
                        1* TOP
                        URGENT
                    </td>
                </tr>
            </t>
            <t t-foreach="range(int(order_groups[client_ref]['products'][product_name]['qty']))" t-as="i">
                <tr style="font-size: 16px; line-height: 1; vertical-align: middle">
                    <td style="font-size:17px" colspan="3">
                        <span style="display:inline-block; width:25px; text-align:right;">
                            <t t-esc="counter"/>
                        </span>.
                        <t t-esc="order_groups[client_ref]['products'][product_name]['barcodes'][i] if len(order_groups[client_ref]['products'][product_name]['barcodes']) > i else '##'"/>
                    </td>
                    <td style="text-align: center;">
                        9 Oct 25
                    </td>
                    <td style="text-align: center;">
                    </td>
                    <td style="text-align: center;">
                        09:39:47
                    </td>
                    <td style="text-align: center;">
                        OK
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                        <div style="display:inline-block; width:20px; height:20px; border:2px solid black; vertical-align:middle;"></div> Packing Out
                    </td>
                </tr>
                <t t-set="counter" t-value="counter + 1"/>
            </t>
            <tr>
                <td colspan="7" style="height: 15px"></td>
            </tr>
            <tr>
                <td colspan="7" style="height: 15px"></td>
            </tr>
        </t>
    </t>
                                        </t>
                                    </t>
                                </tbody>
                            </table>
                            <h5 style="font-weight: bold; margin-top: 20px; page-break-before: always;">Extra Item :</h5>
                            <table class="table table-borderless" style="font-family: Arial; letter-spacing: 0.05em; table-layout: fixed; width: 100%; border-collapse: collapse;">
                                <colgroup>
                                    <col style="width: 13%"/>
                                    <col style="width: 47%"/>
                                    <col style="width: 34%"/>
                                    <col style="width: 8%"/>
                                    <col style="width: 8%"/>
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #a0a0a0; color: black; height: 25px; border: 1px solid black; font-size: 16px; line-height: 1; vertical-align: middle" class="text-center">
                                        <th class="text-center" style="height: 25px; border: 1px solid black; font-weight: 900; padding: 2px 4px;">No</th>
                                        <th class="text-center" style="height: 25px; border: 1px solid black; font-weight: 900; padding: 2px 4px;">Nomor Barcode</th>
                                        <th class="text-center" style="height: 25px; border: 1px solid black; font-weight: 900; padding: 2px 4px;">ID Produk</th>
                                        <th class="text-center" style="height: 25px; border: 1px solid black; font-weight: 900; padding: 2px 4px;">IN</th>
                                        <th class="text-center" style="height: 25px; border: 1px solid black; font-weight: 900; padding: 2px 4px;">OUT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="range(1,21)" t-as="i">
                                        <tr style="font-size: 16px; line-height: 1; vertical-align: middle">
                                            <td style="border: 1px solid black; padding: 2px 4px; text-align: center; height: 25px; vertical-align: middle">
                                                <t t-esc="i"/>
                                            </td>
                                            <td style="border: 1px solid black; padding: 2px 4px; text-align: center; height: 25px;"></td>
                                            <td style="border: 1px solid black; padding: 2px 4px; text-align: center; height: 25px;"></td>
                                            <td style="border: 1px solid black; padding: 2px 4px; text-align: center; height: 25px;"></td>
                                            <td style="border: 1px solid black; padding: 2px 4px; text-align: center; height: 25px;"></td>
                                        </tr>
                                    </t>
                                    <tr>
                                        <td colspan="5" style="height: 15px"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <table style="width: 100%; margin-top: 40px;" class="table table-borderless">
                                <tr>
                                    <td style="text-align: center; width: 33.33%; padding: 10px;">
                                        <p>Approved By</p>
                                        <div style="height: 60px; border-bottom: 1px solid black; margin-top: 20px;"></div>
                                        <p>Opr. Manual</p>
                                    </td>
                                    <td style="text-align: center; width: 33.33%; padding: 10px;">
                                        <p>Approved By</p>
                                        <div style="height: 60px; border-bottom: 1px solid black; margin-top: 20px;"></div>
                                        <p>Opr. Scan</p>
                                    </td>
                                    <td style="text-align: center; width: 33.33%; padding: 10px;">
                                        <p>Approved By</p>
                                        <div style="height: 60px; border-bottom: 1px solid black; margin-top: 20px;"></div>
                                        <p>Opr. Final Check</p>
                                    </td>
                                </tr>
                            </table>
                            <div class="oe_structure"/>
                        </div>
                    </t>
                </t>
            </t>
        </template>
    </data>
</odoo>