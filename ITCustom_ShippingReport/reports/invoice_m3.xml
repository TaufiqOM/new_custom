<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="report_invoice_m3_template">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-call="web.basic_layout">
                        <div class="page" style="font-size: 12px; font-family: 'Arial', sans-serif;">
                            <div class="row">
                                <div class="col-6">
                                </div>
                                <div class="col-6">
                                    <table class="table table-sm table-borderless" style="border-collapse: collapse; line-height: 1.2;">
                                        <tbody>
                                            <tr>
                                                <td style="width: 40%; padding: 0;">
                                                    <strong>Invoice Doc |
                                                        <t t-esc="doc.description"/>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="width: 40%; padding: 0;">
                                                    <strong style="font-size: 14px">INVOICE No.</strong>
                                                </td>
                                                <td style="padding: 0;">
                                                    <strong>:
                                                        <t t-set="roman_months" t-value="['', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII']"/>
                                                        <t t-set="number" t-value="(doc.name.split('/')[-1].lstrip('0') if doc.name else '')"/>
                                                        <t t-esc="f'{number}/TDP/NZ445/EXP/{roman_months[doc.scheduled_date.month]}/{doc.scheduled_date.year % 100}'"/>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0;">
                                                    <strong>Shipped by</strong>
                                                </td>
                                                <td style="padding: 0;">:
                                                    <t t-esc="doc.feeder"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 0;">
                                                    <strong>Sailling On</strong>
                                                </td>
                                                <td style="padding: 0;">:
                                                    <t t-esc="doc.etd_feeder.strftime('%d %B %Y')"/>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <hr class="w-100"/>
                            <div class="row">
                                <div class="col-6" style="line-height: 1.2; font-size: 15px; font-weight: bold">
                                    <strong>TO:</strong>
                                    <br/>
                                    <span t-esc="doc.buyer_id.name or ''"/>
                                    <br/>
                                    <span t-esc="doc.buyer_id.street or ''"/>
                                    <br/>
                                    <span t-esc="(doc.buyer_id.city or '') + (' ' if doc.buyer_id.city and doc.buyer_id.zip else '') + (doc.buyer_id.zip or '') + (', Phone ' if doc.buyer_id.phone else '') + (doc.buyer_id.phone or '') + (' - ' if doc.buyer_id.country_id else '') + (doc.buyer_id.country_id.name or '')"/>
                                    <br/>
                                    <span t-esc="(doc.buyer_id.child_ids and doc.buyer_id.child_ids[0].name or '')"/>
                                </div>
                            </div>
                            <table class="table table-borderless table-sm mt-3" style="font-size: 12px; border-collapse: collapse; line-height: 1.1;">
                                <thead class="text-center" style="font-weight: bold; background-color: #181a1c;">
                                    <tr>
                                        <td style="background-color: #181a1c; color: white; border: 1px solid white; width: 5%;">Shipping Marks</td>
                                        <td style="background-color: #181a1c; color: white; border: 1px solid white; width: 52%; vertical-align: middle">Description</td>
                                        <td style="background-color: #181a1c; color: white; border: 1px solid white; width: 5%;">M3</td>
                                        <td style="background-color: #181a1c; color: white; border: 1px solid white; width: 10%;">Quantity PCS</td>
                                        <td style="background-color: #181a1c; color: white; border: 1px solid white; width: 9%;">Unit/Price USD</td>
                                        <td style="background-color: #181a1c; color: white; border: 1px solid white; width: 10%;">Amount USD</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" style="height: 1px">
                                        </td>
                                    </tr>
                                    <t t-set="product_groups" t-value="{}"/>
                                    <t t-foreach="doc.picking_ids" t-as="picking">
                                        <t t-foreach="picking.move_ids" t-as="move">
                                            <t t-set="product_name" t-value="move.product_id.name or 'N/A'"/>
                                            <t t-if="product_name not in product_groups">
                                                <t t-set="sale_lines" t-value="move.picking_id.sale_id and move.picking_id.sale_id.order_line.filtered(lambda l: l.product_id == move.product_id) or []"/>
                                                <t t-set="unit_price" t-value="sale_lines and sale_lines[0].price_unit or move.product_id.list_price"/>
                                                <t t-set="product_groups" t-value="dict(product_groups, **{product_name: {'qty': 0, 'm3': 0, 'amount': 0, 'unit_price': unit_price}})"/>
                                            </t>
                                            <t t-set="amount" t-value="product_groups[product_name]['unit_price'] * move.quantity"/>
                                            <t t-set="current" t-value="product_groups[product_name]"/>
                                            <t t-set="m3" t-value="move.product_id.volume * move.quantity if move.product_id.volume else 0"/>
                                            <t t-set="product_groups" t-value="dict(product_groups, **{product_name: {'qty': current['qty'] + move.quantity, 'm3': current['m3'] + m3, 'amount': current['amount'] + amount, 'unit_price': current['unit_price']}})"/>
                                        </t>
                                    </t>
                                    <t t-set="counter" t-value="1"/>
                                    <t t-foreach="product_groups" t-as="product_name">
                                        <tr>
                                            <td style="border: 1px solid black" class="text-center">
                                                <t t-esc="counter"/>
                                            </td>
                                            <td style="border: 1px solid black">
                                                <t t-esc="product_name"/>
                                            </td>
                                            <td style="border: 1px solid black; text-align: right">
                                                <t t-esc="'%.2f' % product_groups[product_name]['m3']"/>
                                            </td>
                                            <td style="border: 1px solid black; text-align: right">
                                                <t t-esc="int(product_groups[product_name]['qty'])"/>
                                            </td>
                                            <td style="border: 1px solid black; text-align: right">
                                                <t t-esc="'%.2f' % product_groups[product_name]['unit_price']"/>
                                            </td>
                                            <td style="border: 1px solid black; text-align: right">
                                                <t t-esc="'%.2f' % product_groups[product_name]['amount']"/>
                                            </td>
                                        </tr>
                                        <t t-set="counter" t-value="counter + 1"/>
                                    </t>
                                    <t t-set="total_m3" t-value="sum(product_groups[p]['m3'] for p in product_groups)"/>
                                    <t t-set="total_qty" t-value="sum(product_groups[p]['qty'] for p in product_groups)"/>
                                    <t t-set="total_amount" t-value="sum(product_groups[p]['amount'] for p in product_groups)"/>
                                    <tr style="background-color: #a0a0a0; font-size: 14px">
                                        <td style="border: 1px solid black; text-align: right; font-weight: bold" colspan="2">Grand Total:</td>
                                        <td style="border: 1px solid black; text-align: right">
                                            <t t-esc="'%.2f' % total_m3"/>
                                        </td>
                                        <td style="border: 1px solid black; text-align: right">
                                            <t t-esc="int(total_qty)"/>
                                        </td>
                                        <td style="border: 1px solid black; text-align: right"></td>
                                        <td style="border: 1px solid black; text-align: right">
                                            <t t-esc="'%.2f' % total_amount"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="row mt-4">
                                <div class="col-12" style="line-height: 1.2;">
                                    <strong>NOTE</strong>
                                    <br/>
                                    <t t-set="currency" t-value="doc.picking_ids and doc.picking_ids[0].sale_id.currency_id or env.company.currency_id"/>
                                    <span>TOTAL SAY:
                                        <t t-esc="currency.amount_to_text(total_amount)"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
            </t>
        </template>
    </data>
</odoo>